local oldpe = os.pullEvent

local function clear()
term.setBackgroundColor(tbar)
term.setTextColor(sndtxt)
term.clear()
term.setCursorPos(1,1)
write("Enter ")
term.setTextColor(prog)
write("Home, Exit, Back")
term.setTextColor(sndtxt)
write(" or ")
term.setTextColor(prog)
write("Start")
term.setTextColor(sndtxt)
print(" to go back")
print(OStag.." Shell")
print("")
term.setTextColor(tbartxt)
end
clear()
while true do
 term.setTextColor(tbartxt)
 local currdir = shell.dir()
 write(currdir.." -> ")
 os.pullEvent = os.pullEventRaw
 local input = read()
 local linput = string.lower(input)
 os.pullEvent = oldpe
 if linput:find('reboost') or linput:find("programs") or (linput:find("rm") and linput:find("user")) or (linput:find("rename") and linput:find("user")) or (linput:find("mv") and linput:find("user")) or (linput:find("move") and linput:find("user")) or linput:find("meta") or linput:find("startup") then
  term.setTextColor(colors.red)
  print("Forbidden Command!")
 elseif linput == "start" or linput == "home" or linput == "exit" or linput == "back" or linput == "close" then
  break
 elseif linput == "reboot" then
  instashut = true
  shell.run("/ReboOSt/reboot")
 elseif linput == "shutdown" then
  instashut = true
  shell.run("/ReboOSt/shut-off")
 elseif linput == "about" then
  term.setTextColor(sndtxt)
  print("ReboOSt was originally build upon ApfelOS. While ReboOSt still contains some of the internal Workloads, it was massively improved.")
 elseif linput == "themes" then
  term.setTextColor(sndtxt)
  print([[Usage: -view        --shows current theme setting
       -modify      --changes theme settings
       -modify:all  --changes theme in luaIDE
       -save        --saves current config
       -discard     --returns to old config
       -gui         --opens Graphical Interface]])
  term.setTextColor(tbartxt)
 elseif linput == "themes -gui" then
  shell.run("/ReboOSt/thmchg")
  clear()
 elseif linput == "themes -discard" then
  shell.run("/User/"..UserName.."/..colortheme")
  clear()
  term.setTextColor(sndtxt)
  print("Discarded current theme!")
  term.setTextColor(tbartxt)
 elseif linput == "themes -view" then
  term.setTextColor(sndtxt)
  print("tbar = "..tbar)
  print("mbar = "..mbar)
  print("body = "..body)
  print("wico = "..wico)
  print("crashscreen = "..crashscreen)
  print("crashscreentxt = "..crashscreentxt)
  print("prog = "..prog)
  print("buttonBack = "..buttonBack)
  print("buttonBatxt = "..buttonBatxt)
  print("buttonReboot = "..buttonReboot)
  print("buttonRetxt = "..buttonRetxt)
  print("buttonShut = "..buttonShut)
  print("buttonShtxt = "..buttonShtxt)
  print("tbartxt = "..tbartxt)
  print("mbartxt = "..mbartxt)
  print("bodytxt = "..bodytxt)
  print("wicotxt = "..wicotxt)
  print("sndtxt = "..sndtxt)
  term.setTextColor(tbartxt)
 elseif linput == "themes -modify:all" then
  shell.run("/ReboOSt/luaIDE", "/User/"..UserName.."/..colortheme")
  clear()
 elseif linput == "themes -modify" then
  print("Please specify the setting you want to change. (Variable Name)")
  write("   > ")
  os.pullEvent = os.pullEventRaw
  input = string.lower(read())
  os.pullEvent = oldpe
  local function onoff(var, vars)
   print("Which Color should "..vars.." get?")
   write("   > ")
   os.pullEvent = os.pullEventRaw
   input = read()
   os.pullEvent = oldpe
   if input == "black" then var = colors.black print(vars.." was changed to "..input)
   elseif input == "gray" then var = colors.gray print(vars.." was changed to "..input)
   elseif input == "lightGray" then var = colors.lightGray print(vars.." was changed to "..input)
   elseif input == "white" then var = colors.white print(vars.." was changed to "..input)
   elseif input == "yellow" then var = colors.yellow print(vars.." was changed to "..input)
   elseif input == "orange" then var = colors.orange print(vars.." was changed to "..input)
   elseif input == "red" then var = colors.red print(vars.." was changed to "..input)
   elseif input == "purple" then var = colors.purple print(vars.." was changed to "..input)
   elseif input == "magenta" then var = colors.magenta print(vars.." was changed to "..input)
   elseif input == "lightBlue" then var = colors.lightBlue print(vars.." was changed to "..input)
   elseif input == "cyan" then var = colors.cyan print(vars.." was changed to "..input)
   elseif input == "blue" then var = colors.blue print(vars.." was changed to "..input)
   elseif input == "green" then var = colors.green print(vars.." was changed to "..input)
   elseif input == "lime" then var = colors.lime print(vars.." was changed to "..input)
   elseif input == "pink" then var = colors.pink print(vars.." was changed to "..input)
   elseif input == "brown" then var = colors.brown print(vars.." was changed to "..input)
   else
    print("Not a Color! Exiting...")
   end
   return var
  end
  if input == "tbar" then tbar = onoff(tbar, "Header BG")
  elseif input == "tbartxt" then tbartxt = onoff(tbartxt, "Header text")
  elseif input == "mbar" then mbar = onoff(mbar, "Panel BG")
  elseif input == "mbartxt" then mbartxt = onoff(mbartxt, "Panel text")
  elseif input == "body" then body = onoff(body, "Menu BG")
  elseif input == "bodytxt" then bodytxt = onoff(bodytxt, "Menu text")
  elseif input == "wico" then wico = onoff(wico, "Window Header & Text")
  elseif input == "wicotxt" then wicotxt = onoff(wicotxt, "Window BG & Header text")
  elseif input == "buttonBack" then buttonBack = onoff(buttonBack, "Back button")
  elseif input == "buttonBatxt" then buttonBatxt = onoff(buttonBatxt, "Back button text")
  elseif input == "buttonReboot" then buttonReboot = onoff(buttonReboot, "Reboot button")
  elseif input == "buttonRetxt" then buttonRetxt = onoff(buttonRetxt, "Reboot button text")
  elseif input == "buttonShut" then buttonShut = onoff(buttonShut, "Shutdown button")
  elseif input == "buttonShtxt" then buttonShtxt = onoff(buttonShtxt, "Shutdown button text")
  elseif input == "crashscreen" then crashscreen = onoff(crashscreen, "Crashscreen BG")
  elseif input == "crashscreentxt" then bodytxt = onoff(bodytxt, "Crashscreen text")
  elseif input == "prog" then prog = onoff(prog, "Program indicator text")
  elseif input == "sndtxt" then sndtxt = onoff(sndtxt, "Second text Color")
  else print("Not a Variable! Exiting...") end
 elseif linput == "themes -save" then
  local file = fs.open("/User/"..UserName.."/..colortheme", "w")
  file.writeLine("tbar = "..tbar)
  file.writeLine("mbar = "..mbar)
  file.writeLine("body = "..body)
  file.writeLine("wico = "..wico)
  file.writeLine("crashscreen = "..tbar)
  file.writeLine("crashscreentxt = "..prog)
  file.writeLine("prog = "..prog)
  file.writeLine("buttonBack = "..buttonBack)
  file.writeLine("buttonBatxt = "..buttonBatxt)
  file.writeLine("buttonReboot = "..buttonReboot)
  file.writeLine("buttonRetxt = "..buttonRetxt)
  file.writeLine("buttonShut = "..buttonShut)
  file.writeLine("buttonShtxt = "..buttonShtxt)
  file.writeLine("tbartxt = "..tbartxt)
  file.writeLine("mbartxt = "..mbartxt)
  file.writeLine("bodytxt = "..bodytxt)
  file.writeLine("wicotxt = "..wicotxt)
  file.writeLine("sndtxt = "..sndtxt)
  file.close()
  term.setTextColor(sndtxt)
  print("Theme saved!")
  term.setTextColor(tbartxt)
 elseif linput == "settings" then
  term.setTextColor(sndtxt)
  print([[Usage: -view        --shows current config 
       -modify      --changes config
       -modify:all  --changes config in luaIDE
       -save        --saves current config
       -discard     --returns to old config
       -gui         --opens Graphical Interface]])
  term.setTextColor(tbartxt)
 elseif linput == "settings -gui" then
  shell.run("/ReboOSt/ctrlpnl")
  clear()
 elseif linput == "settings -modify:all" then
  shell.run("/ReboOSt/luaIDE", "/ReboOSt/configs/main")
  clear()
 elseif linput == "settings -modify" then
  print("Please specify the setting you want to change. (Variable Name)")
  write("   > ")
  os.pullEvent = os.pullEventRaw
  input = string.lower(read())
  os.pullEvent = oldpe
  local function onoff(var, vars)
   print("Turn "..vars.." on or off?")
   write("   > ")
   os.pullEvent = os.pullEventRaw
   input = string.lower(read())
   os.pullEvent = oldpe
   if input == "on" then
    var = true
	print(vars.." was changed to true.")
   elseif input == "off" then
    var = false
	print(vars.." was changed to false.")
   else
    print("Exiting...")
   end
   return var
  end
  if input == "autoupdate" then
   autoupdate = onoff(autoupdate, "Auto Update")
  elseif input == "rosdebug" then
   rosdebug = onoff(rosdebug, "Debug Mode")
  elseif input == "pfolder" then
   pfolder = onoff(pfolder, "Programs Folder icon")
  elseif input == "gfolder" then
   gfolder = onoff(gfolder, "Games Folder icon")
  elseif input == "termstart" then
   termstart = onoff(termstart, "Shell after login")
  elseif input == "updatstream" then
   print("Turn Dev-Update-Stream on or off?")
   write("   > ")
   os.pullEvent = os.pullEventRaw
   input = string.lower(read())
   os.pullEvent = oldpe
   if input == "on" then
	print("You'll now get Updates from the Development-Stream")
	updatstream = "development"
   elseif input == "off" then
	print("You'll now get Updates from the Release-Stream")
	updatstream = "release"
   else
    print("Exiting...")
   end
  else
   print("Not a setting! Exiting...")
  end
 elseif linput == "settings -discard" then
  shell.run("/ReboOSt/configs/main")
 elseif linput == "settings -save" then
  local file = fs.open("/ReboOSt/configs/main", "w")
  if autoupdate then
   file.writeLine("autoupdate = true")
  else
   file.writeLine("autoupdate = false")
  end
  if rosdebug then
   file.writeLine("rosdebug = true")
  else
   file.writeLine("rosdebug = false")
  end
  if pfolder then
   file.writeLine("pfolder = true")
  else
   file.writeLine("pfolder = false")
  end
  if gfolder then
   file.writeLine("gfolder = true")
  else
   file.writeLine("gfolder = false")
  end
  if termstart then
   file.writeLine("termstart = true")
  else
   file.writeLine("termstart = false")
  end
  file.writeLine('updatstream = "'..updatstream..'"')
  file.close()
  print("Settings Saved!")
 elseif linput == "settings -view" then
  term.setTextColor(sndtxt)
  write("autoupdate = ") if autoupdate then print("true") else print("false") end
  write("rosdebug = ") if rosdebug then print("true") else print("false") end
  write("pfolder = ") if pfolder then print("true") else print("false") end
  write("gfolder = ") if gfolder then print("true") else print("false") end
  write("termstart = ") if tempstart then print("true") else print("false") end
  print("updatstream = "..updatstream)
  term.setTextColor(tbartxt)
 elseif linput == "shell" then
  term.setTextColor(sndtxt)
  write("This is ReboOSt Shell. Basicly it is just another GUI for ReboOSt. Use ")
  term.setTextColor(prog)
  write("shell -? or shell -help")
  term.setTextColor(sndtxt)
  print(" for extra ReboOSt commands.")
 elseif linput == "shell -?" or linput == "shell -help" then
  term.setTextColor(sndtxt)
  print([[Use "themes" to modify the current theme.
Use "settings" to modify current settings.
Use "files" to open File Browser.
Use "sketch" to open sketch from anywhere.]])
  term.setTextColor(tbartxt)
 elseif linput == "files" then
  shell.run("/ReboOSt/fbrws")
  clear()
 elseif linput == "luaide" then
  shell.run("/ReboOSt/luaIDE")
  clear()
 elseif linput == "sketch" then
  shell.run("/Programs/sketch")
  clear()
 elseif linput == "clear" then
  clear()
 elseif linput == "debug" then
  if rosdebug then
   write("Please enter Mainainance Password: ")
   os.pullEvent = os.pullEventRaw
   input = read("*")
   local inpute = encryption.sha256(input)
    if inpute == "10a462ec70472bd9367839a857e709f366ff7399f9e0becb9aa5ad70b13a15ea" then
    print("Warning! This is very experimental and you can break the whole OS with it! Use at own risk! Enter close to get back to normal shell.")
    local debugshell = true
    while debugshell do
     term.setTextColor(sndtxt)
     write(" -> ")
     term.setTextColor(tbartxt)
     os.pullEvent = os.pullEventRaw
     input = read()
     os.pullEvent = oldpe
     linput = string.lower(input)
     if linput == "cpass" then
      print("What User do you want to edit?")
 	  term.setTextColor(sndtxt)
      write(" -> ")
  	  term.setTextColor(tbartxt)
      os.pullEvent = os.pullEventRaw
      ouser = read()
	  if ouser == "" then
	   print("Please enter a username! Exiting...")
      elseif fs.exists("/User/"..ouser) then
       print("Enter new User Name")
	   term.setTextColor(sndtxt)
	   write(" -> ")
	   term.setTextColor(tbartxt)
	   os.pullEvent = os.pullEventRaw
	   nuser = read()
	   lnuser = string.lower(input)
	   os.pullEvent = oldpe
	   if nuser == "" or lnuser == "root" or lnuser == "reboot" or lnuser == "shutdown" then
	    print("Forbidden Username! Exiting.")
	   else
	    fs.move("/User/"..ouser , "/User/"..nuser)
	    print("Please enter new Password")
	    term.setTextColor(sndtxt)
	    write(" -> ")
	    term.setTextColor(tbartxt)
	    os.pullEvent = os.pullEventRaw
	    local pass = read()
	    local passe = encryption.sha256(pass)
	    local file = fs.open("/User/"..nuser.."/..meta", "r")
	    local metaData = {}
	    local line = file.readLine()
	    repeat
	    table.insert(metaData,line)
	    line = file.readLine()
	    until line == nil
	    local file = fs.open("/User/"..Name.."/..meta", "w")
	    file.writeLine(passe)
	    file.writeLine(metaData[2])
	    file.close()
	    passe = nil
	    pass = nil
	   end
      else
       print("User dosn't exists! Exiting.")
      end
     elseif linput == "close" then
      print("Exiting debug shell...")
      break
     else
      shell.run(input)
     end
    end
    else
     print("Wrong Password! Exiting...")
    end
  else
  print("Debug Mode must be enabled!")
  end
 else
  shell.run(input)
 end
end
